<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>UITableView 与手势识别的坑 | fminor 的个人博客</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">fminor 的个人博客</a><span class="subtitle">-- for General CJ</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>UITableView 与手势识别的坑</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-05-26</div><div class="post-tags"><a class="post-tag-link" href="/tags/iOS/">iOS</a></div></div></div><article><div class="container post"><p>最近做项目时遇到这样的需求：在某个 UIView 中放置了一个 UITableView，同时作为父容器的 UIView 添加了一个点击手势，在点击 UIView 时，整个页面全部消失。本来这件事情看上去人畜无害，只要在 UIView 上 addGestureRecognizer，加上消失的事件就行了。</p>
<p>然而，事实并非如此顺利。由于在 UITableView 的父容器添加了对用户手势的检测，点击事件竟然再也传不到 UITableView 上面，导致无法进入 selectRow 的回调。</p>
<p>这个事情当时觉得匪夷所思，因为 tableView 在层次上明明是位于它的容器上的，理应是它先接收到点击事件，而事实并非如此。</p>
<p>因此，特地参考了苹果的开发文档，关于手势识别与 iOS 控件接收触摸事件的先后顺序，有这一段并不起眼的说明：</p>
<blockquote>
<p><em>There may be times when you want a view to receive a touch before a gesture recognizer. But, before you can alter the delivery path of touches to views, you need to understand the default behavior. In the simple case, when a touch occurs, the touch object is passed from the UIApplication object to the UIWindow object. Then, <strong>the window first sends touches to any gesture recognizers attached the view where the touches occurred (or to that view’s superviews), before it passes the touch to the view object itself.</strong></em></p>
</blockquote>
<p><img src="https://developer.apple.com/library/ios/documentation/EventHandling/Conceptual/EventHandlingiPhoneOS/Art/path_of_touches_2x.png" alt="" title="touch事件的传递路径"></p>
<p>重点就在上面粗体字标出来的那句话。它的意思是每个 View 在将要接收到 touch 事件之前，这个事件都会先被提交给手势识别模块。而从之前的事实来看，如果有手势被正确识别出来，这个 touch 事件不会再传递给 View ，只会进入手势的手续处理。而 UITableView 作为它的 SubView，就接收不到 touch 事件，进而无法识别 selectRow 之类的事件(最后这一句话有待进一步验证)。</p>
<p>如此奇葩的问题，临时解决起来也不算太困难。只要实现父容器的 gestureRecognizer 的 delegate（ 可以是 ViewController, 也可以是 View ）方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)gestureRecognizer:(UIGestureRecognizer *)gestureRecognizer shouldReceiveTouch:(UITouch *)touch</span><br><span class="line">&#123;</span><br><span class="line">    if ( [NSStringFromClass([touch.view class]) isEqualToString:@&quot;nameOfSuperView&quot;] ) &#123;</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return  NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断当前 touch 是否是真的点到了父容器还是点在 tableView 上。只有点到父容器才接收 touch 事件。</p>
<p>然而这一段代码还是比较奇葩，或许有更简洁的办法也未可知。</p>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">fminor 的个人博客</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script></body></html>